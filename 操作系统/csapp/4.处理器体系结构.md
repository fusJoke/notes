## 4.1 Y86-64指令集体系结构

这个处理器将每条指令的执行分解成5步，每个步骤都由一个独立的硬件部分或者阶段来处理。

指令步经流水线的各个阶段，且每个时钟周期都有一个新指令进入流水线。

为了使这个处理器保留Y86-64 ISA的顺序行为，就要求处理很多冒险或者冲突情况，冒险就是一条指令的位置或者操作数依赖与其他仍在流水线的指令。

### 4.1.1 程序员可见的状态

Y86-64程序中的每条指令都会读取或者改变处理器状态的某些部分，这些为程序员可见状态。

Y86-64有个15个程序寄存器：%rax，%rcx、%rdx，%rbx，%rsp、%rbp、%rsi、%rdi和%r8到%r14。

每个程序寄存器都存储一个64位的字。

%rsp被入栈，出栈，调用和返回指令作为栈指针。

有三个一位的条件码：zf、sf和of，保存着最近的算术或逻辑指令所造成影响的有关信息。

程序计数器PC存放当期正在执行指令的地址。

内存从概念上面是一个很大的字节数组，保存着程序和数据。

Y86-64程序用虚拟地址来引用内存位置。

状态吗stat，表明程序执行的总体状态。

<img src="/Users/wangfusheng/Documents/notes/操作系统/csapp/.assets/image-20221012231652647.png" alt="image-20221012231652647" style="zoom:50%;" /> 



### 4.1.2 Y86-64 指令

汇编代码风格类似于x86-64的att格式

+ X86-64的movq指令分成4个不同的指令：irmovq，rrmovq，mrmoq和rmmovq分别显式地指明源和目的格式。
  源可以是立即数（i），寄存器（r）和内存（m）

+ 4个整数操作指令，addq、subq、andq和xorq。只对寄存器数据进行操作。
+ 7个跳转指令jmp、jle、jl、je、jne和jq
+ 6个条件传送指令：cmovle、cmovl、cmove、cmovee、cmovge和cmovg
+ call指令将返回地址入栈，然后跳到目标地址。ret指令从这样的调用返回。
+ pushq和popq指令实现入栈和出栈。
+ halt指令停止指令的执行。

<img src="/Users/wangfusheng/Documents/notes/操作系统/csapp/.assets/image-20221013211308899.png" alt="image-20221013211308899" style="zoom:50%;" />  

### 4.1.3 指令编码

4-2给出指令的字节级编码。

每条指令的第一字节表明指令类型：高4位代码，低4位功能。

15个寄存器都有对应一个寄存器标识符（register ID）

<img src="/Users/wangfusheng/Documents/notes/操作系统/csapp/.assets/image-20221013211712882.png" alt="image-20221013211712882" style="zoom:50%;" /> 

有的指令不止一个字节长，可能有附加的寄存器指示符字节，指定一个或二个寄存器。被称为rA和rB。

有些指令需要一个附加的4字节常数字。这个字可以作为irmovq的立即数数据，rmmovq和mrmoq的地址指示符的偏移量，以及分支指令和调用指令的目标地址。

指令集的一个重要性质就是字节编码必须有唯一的解释。所以，一个字节序列要么是唯一的指令序列的编码，要么是非法的。



### 4.1.4 Y86-64异常

<img src="/Users/wangfusheng/Documents/notes/操作系统/csapp/.assets/image-20221013215235762.png" alt="image-20221013215235762" style="zoom:50%;" /> 

遇到异常的时候，系统会调用异常处理exception handler



### 4.1.6 y86-64 指令一些详情

pushq指令会把栈指针减8，并且将一个寄存器写入内存。

### 4.2 逻辑设计和硬件控制语言HCL

高电压表示1，低电压表示0

数字系统组成的部分：

+ 计算对位进行操作的函数的组合逻辑
+ 存储位的存储器单元
+ 控制存储器单元更新的时钟信号

### 4.2.1 逻辑门

逻辑门只对单个位的数进行操作。

<img src="/Users/wangfusheng/Documents/notes/操作系统/csapp/.assets/image-20221013222439209.png" alt="image-20221013222439209" style="zoom:50%;" /> 

### 4.2.2 组合电力和HCL 布尔表达式

组合电路：很多逻辑门组成一个网，就构建计算块。

+ 每个逻辑门的输入必须连接到1）一个系统输入，2）某个存储器单元的输出，3）某个逻辑门的输出
+ 两个或多个逻辑门不能连接到一起
+ 这个网必须是五环

### 4.2.3 字级的组合电路和HCL整数表达式

<img src="/Users/wangfusheng/Documents/notes/操作系统/csapp/.assets/image-20221013224518615.png" alt="image-20221013224518615" style="zoom:50%;" /> 

### 4.2.4 集合关系



### 4.2.5 存储器和时钟

组合电路，不存储任何信息。它们只是简单响应输入信号，产生等于输入的某个函数的输出。

为了产生时序电路，必须引入按位存储信息的设备。

存储设备都是同一个时钟控制的，时钟是一个周期性信号。

两类存储器设备：

+ 时钟寄存器（寄存器）存储的那个位或者字。时钟信号控制寄存器加载输入值
+ 随机访问存储器（内存）存储多个字。

硬件寄存器：寄存器直接将他的输入和输出连接到电路的其他部分。

程序寄存器：cpu中为数不多的可寻址的字。

<img src="/Users/wangfusheng/Documents/notes/操作系统/csapp/.assets/image-20221015004128425.png" alt="image-20221015004128425" style="zoom:50%;" /> 

 <img src="/Users/wangfusheng/Documents/notes/操作系统/csapp/.assets/image-20221015004145474.png" alt="image-20221015004145474" style="zoom:50%;" /> 

这样一个多端口随机访问的存储器允许同时进行多个读和写操作。

寄存器有不是组合电路，因为它内部存储。

向寄存器文件写入字是由时钟信号控制的。

寄存器文件可读可写。



## 4.3  y86-64的顺序实现



### 4.3.1 将处理组织成阶段

+ 取指：从内存读取指令字节，地址为程序计数器（pc）的值。
+ 译码：译码阶段从寄存器文件读入最多两个操作数
+ 执行：在执行阶段，算术逻辑单元要么执行指令指明的操作，计算内存引用的有效地址。要么增加或减少栈指针。在此也可能设置条件码。对一条条件传送指令来说，这个阶段会检验条件码和传送条件。如条成，则更目标寄存器。
+ 访存：可将数据写入内存，或将内存读出数据
+ 写回：写两个结果到寄存器
+ 更新PC：设置成下一条指令



## 4.3.2 seo硬件结构

<img src="/Users/wangfusheng/Documents/notes/操作系统/csapp/.assets/image-20221015185808531.png" alt="image-20221015185808531" style="zoom:50%;" />

​	

