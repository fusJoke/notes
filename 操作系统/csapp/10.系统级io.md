

### 10.1 unix io

一个linux文件就是m字节的序列：

所有的i/o设备都是文件，所有的输入和输入当初对文件的读和写。

+ 打开文件。内核会返回一个叫做文件描述符的非负整数。
+ linux创建的每个进程都打开三个文件：标准输入(描述符0)，标准输出（描述符1）和标准错误（描述符2）。

+ 改变当前文件的位置。对于每个打开的文件，内核保持着一个文件位置为k，初始为0。
+ 读写文件。一个读操作就是从文件复制n个字节到内存，从当前文件位置k开始到k+n。end of file（eof错误）
+ 关闭文件。内核释放文件打开的数据结构，并将文件描述符恢复到可用的描述符池



### 10.2 文件类型

+ 普通文件包含任意数据。文件文件和二进制文件。文本文件只含ascii或unicode字符的普通文件。linux文本文件包含一个文本行（text line）序列。以换行符(\n)结束
+ 目录是包含一组链接的文件。每个链接是文件名到某一文件的映射。每个目录都有：（.）以及（..）
+ 套接字用来另一个进程跨网络通信

作为上下文的一部分，每个进程都有一个当前工作目录来确定其再目录层次结构中的当前位置。

+ 绝对路径名。
+ 相对路径名。



### 10.3 打开和关闭文件

进程通过open函数来打开或创建一个新文件。

```
int open(char *filename, int flags, mode_t mode)
```

open函数将filename转换为一个文件描述符，并且返回描述符数字。总是在进程中没有打开的最小描述符。

+ O_RDONLY:只读。
+ O_WRONLY:只写。
+ O_RDWR:可读可写。
+ O_CREAT:文件不存则创空文件
+ O_TRUNC:如文件已经存在，则截断它。
+ O_APPEND: 在每次写操作前，设置文件位置到文件结尾处。

mode参数指定新文件的访问权限位。

作为上下文的一部分，每个进程都有一个umask。文件的访问权限位被设置为 mode & umask。

<img src="/Users/wangfusheng/Documents/notes/操作系统/csapp/.assets/image-20221125103318974.png" alt="image-20221125103318974" style="zoom: 67%;" /> 



#### 10.4 读写文件

应用程序调用read和write函数来执行输入和输出。

```
ssize_t read(int fd, void *buf, size_t n)

ssize_t write(int fd, const void *buf, size_t n)
```

read函数从描述符为fd的当前文件位置复制最多n个字节到内存位置buf。返回值-1表示一个错误，返回值0表示EOF

write函数从内存位置buf复制至多n个字节到描述符fd的当前文件位置。

lseek函数改变文件的当前位置。



read和write传送的字节比应用要求的要少的情况:

+ 读时遇到EOF；
+ 从终端读取文本行
+ 读和写网络套接字



### 10.5 用RIO包健壮地读写

RIO提供两类不同的函数：

+ 无缓冲的输入输出函数。这些函数直接在内存和文件之间传送数据，没有应用级缓冲
+ 带缓冲的输入函数。



### 10.6 读取文件元数据

应用程序能够通过调用stat和fstat函数，检索关于文件的信息。



### 10.7 读取目录内容

用readdir系列函数来读取目录的内容。



### 10.8 共享文件

内核用三个相关的数据结构来表示打开的文件：

+ 描述符表。每个进程都有它独立的描述符表，它的表项是由进程打开的文件描述符来索引的。每个打开的文件描述符表项指向文件表的一个表项
+ 文件表。打开文件的集合是由一张文件表来表示的，所有的进程共享这张表。每个文件表的表项组成包括当前文件的位置，引用计数，以及一个指向v-node表中对应表项的指针。关闭一个描述符会减少相应的文件表表项中的引用计数
+ v-node表。同文件表一样，所有进程共享这张v-node表。每个表项包含stat结构中的大多数信息，包括st_mode和st_size成员。



<img src="/Users/wangfusheng/Documents/notes/操作系统/csapp/.assets/image-20221124114954246-9261796.png" alt="image-20221124114954246" style="zoom: 67%;" />  

多个描述符也可以通过不同的文件项来引用同一个文件。每个描述符都有它的文件位置。

所以对不同的描述符的读操作可以从文件的不同位置获取数据。

<img src="/Users/wangfusheng/Documents/notes/操作系统/csapp/.assets/image-20221124140125783.png" alt="image-20221124140125783" style="zoom:67%;" /> 



### 10.9 重定向

linux 提供io重定向操作符。允许用户将磁盘文件和标准输入输出联系起来。

```
ls > foo.txt
```



### 10.10 标准 I/O

标准IO库将一个打开的文件模型化为一个流。一个流就是一个指向FILE类型的结构指针。

<img src="/Users/wangfusheng/Documents/notes/操作系统/csapp/.assets/image-20221124165945902.png" alt="image-20221124165945902" style="zoom:67%;" /> 