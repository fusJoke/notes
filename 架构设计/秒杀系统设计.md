## 秒杀系统设计原则

秒杀主要解决的两个问题，并发读和并发写

### 1.数据尽量少

用户请求数据尽量少。包括上传给系统的数据以及系统返回的数据。服务器在写网络时通常都要做压缩和字符编码，这些都非常消耗 CPU，所以减少传输的数据量可以显著减少 CPU 的使用

### 2.请求数量尽量少

用户请求的页面返回后，浏览器渲染的还有额外的请求。CSS/JavaScript、图片，以及 Ajax 请求等。

请求合并，合并css文件和js文件。

### 3.路径尽量短

所谓“路径”，就是用户发出请求到返回数据这个过程中，需求经过的中间的节点数。每经过一个节点，一般都会产生一个新的 Socket 连接

### 4.依赖要尽量少

所谓依赖，指的是要完成一次用户请求必须依赖的系统或者服务，这里的依赖指的是强依赖。

举个例子，比如说你要展示秒杀页面，而这个页面必须强依赖商品信息、用户信息，还有其他如优惠券、成交列表等这些对秒杀不是非要不可的信息（弱依赖），这些弱依赖在紧急情况下就可以去掉

### 5.不要单点

![image-20230109085434439](/Users/wangfusheng/Documents/notes/架构设计/.assets/image-20230109085434439.png)





## 动静分离的方案



### 何为动静数据

**“动态数据”和“静态数据”的主要区别就是看页面中输出的数据是否和 URL、浏览者、时间、地域相关，以及是否含有 Cookie 等私密数据**

**第一，你应该把静态数据缓存到离用户最近的地方**。静态数据就是那些相对不会变化的数据，因此我们可以把它们缓存起来。缓存到哪里呢？常见的就三种，用户浏览器里、CDN 上或者在服务端的 Cache 中

**第二，静态化改造就是要直接缓存 HTTP 连接**。相较于普通的数据缓存而言，你肯定还听过系统的静态化改造。静态化改造是直接缓存 HTTP 连接而不是仅仅缓存数据，如下图所示，Web 代理服务器根据请求 URL，直接取出对应的 HTTP 响应头和响应体然后直接返回，这个响应过程简单得连 HTTP 协议都不用重新组装，甚至连 HTTP 请求头也不需要解析。



## 如何做动静分离的改造



1. url唯一化
2. 分离浏览器相关的因素
3. 分离时间因素
4. 异步化低于因素
5. 去掉cookie



## 热点数据处理

##### 什么是热点？

热点数据和热点操作。

热点操作，添加购物车，零点大量下单之类。这些操作可以在细分成写请求和读请求。
读请求的优化空间要大一些，而写请求的瓶颈一般都在存储层，优化的思路就是根据 CAP 理论做平衡

热点数据，又细分成静态热点数据和动态热点数据。静态根据历史记录分析，报名系统等提前知道的数据

发现热点数据。





## 流量销峰

针对秒杀这一场景，削峰从本质上来说就是更多地延缓用户请求的发出，以便减少和过滤掉一些无效请求，它遵从“请求数要尽量少”的原则

#### 排队

<img src="/Users/wangfusheng/Documents/notes/架构设计/.assets/image-20230306174333796.png" alt="image-20230306174333796" style="zoom: 33%;" /> 

 

#### 分层过滤

<img src="/Users/wangfusheng/Documents/notes/架构设计/.assets/image-20230306174555489.png" alt="image-20230306174555489" style="zoom:50%;" /> 

+ 大部分的数据和流量在用户浏览器或者cdn上获取，
+ 第二次尽量走缓存，过滤一些无效的请求
+ 第三层后台系统，做好系统保护和限流
+ 在数据库做强一致性校验

**分层过滤的核心思想是：在不同的层次尽可能地过滤掉无效请求，让“漏斗”最末端的才是有效请求**

分层校验的基本原则是：

1. 将动态请求的读数据缓存（Cache）在 Web 端，过滤掉无效的数据读；
2. 对读数据不做强一致性校验，减少因为一致性校验产生瓶颈的问题；
3. 对写数据进行基于时间的合理分片，过滤掉过期的失效请求；
4. 对写请求做限流保护，将超出系统承载能力的请求过滤掉；
5. 对写数据进行强一致性校验，只保留最后有效的数据。
