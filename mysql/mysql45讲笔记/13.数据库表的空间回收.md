### 13.数据库表的空间回收

1. #### 表数据既可以存在共享表空间里，也可以是单独的文件

   innodb_file_per_table=off表示表的数据放在系统共享表空间，也就是跟数据字典放在一起
   innodb_file_per_table=on表示InnoDB 表数据存储在一个以 .ibd 为后缀的文件
   注：innodb_file_per_table 设置为 ON，是推荐做法
   共享表空间是什么？ibdata*的共享表空间
   
2. #### 数据删除流程

   1. 单条记录被删除。在innoDb引擎中，删除记录R，引擎只会将该记录R标记为删除，插入新数据的时候R会被复用。
   2. 整个数据页被删除。整个页被复用。
   3. 数据页的复用和记录的复用的区别。记录的当加入的新数据要在大于父节点的值和父节点的兄弟节点之间才会被复用。整个数据页则是可以复用在任何位置
   4. 删除数据和插入数据同样都会造成空洞。数据页pageA满了之后，插入新的数据，申请新的数据页pageB来存放数据，pageA末尾就存在空洞
   5. delete命令把整个表的数据删除呢。结果就是，所有的数据页都会被标记为可复用

3. #### 重建表，去掉表的空洞

   1. 建一张结构相同的表，将旧表记录逐条插入到新表中，新建立的表没有空洞。这里可以使用，alter table A engine=InnoDB 命令来重建表。

   2. Online DDL 的流程。MySQL 5.6 版本开始引入

      1.建立一个临时文件，扫描表 A 主键的所有数据页；
      2.用数据页中表 A 的记录生成 B+ 树，存储到临时文件中；
      3.生成临时文件的过程中，将所有对 A 的操作记录在一个日志文件（row log）中
      4.临时文件生成后，将日志文件中的操作应用到临时文件，得到一个逻辑数据上与表 A 相同的数据文件。
      5.临时文件替换表A的数据文件

4. #### Online 和 inplace
   
   alter table t engine=innodb,ALGORITHM=inplace;


​	

